<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Evacuation Route</title>
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=w5mst5owqn&submodules=geocoder&language=en"></script>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=w5mst5owqn&submodules=geocoder,directions"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: #343a40;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(0, 122, 255, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(0, 122, 255, 0.2);
        }

        .header h1 {
            font-size: 2.2em;
            color: #007AFF;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
            font-weight: 500;
            margin-bottom: 0;
            line-height: 1.4;
        }

        .header p strong {
            color: #007AFF;
            font-weight: 600;
        }

        .emergency-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 1em;
            color: #555;
        }

        .emergency-info span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #map {
            width: 100%;
            height: 500px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        .info-window {
            padding: 10px 16px;
            font-size: 15px;
            color: #343a40;
            background: white;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        #goBtn {
            display: none;
            width: 100%;
            padding: 18px 20px;
            font-size: 1.3em;
            color: white;
            background-color: #007AFF;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: all 0.3s;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.2);
            font-weight: 700;
        }

        #goBtn:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .status {
            margin-top: 20px;
            padding: 18px;
            background: white;
            border-radius: 8px;
            font-size: 1.1em;
            color: #666;
            border: 1px solid #e9ecef;
            font-weight: 500;
        }

        .emergency-alert {
            background: #007AFF;
            color: white;
            padding: 14px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1em;
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.2);
            letter-spacing: -0.3px;
        }

        .emergency-alert span {
            margin-right: 12px;
            font-size: 1.2em;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        #goBtn {
            animation: pulse 2s infinite;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .header h1 {
                font-size: 2em;
            }
            #map {
                height: 50vh;
            }
            #goBtn {
                font-size: 1.2em;
                padding: 16px 20px;
            }
            .emergency-alert {
                font-size: 1em;
                padding: 14px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® Emergency Evacuation Route</h1>
            <p>A <strong id="disaster-type">earthquake</strong> has occurred in <strong id="disaster-location">Gangnam-gu, Seoul</strong>.<br></p>
            <div class="emergency-info">
                <span>üïí <span id="current-time">--:--</span></span>
                <span>üìç Distance from current location: <span id="disaster-distance">3.7km</span></span>
            </div>
        </div>
        <div class="emergency-alert">
            <span>‚ö° Guiding you to the nearest safe shelter from your current location</span>
        </div>
        <div id="map"></div>
        <a id="goBtn" href="#" target="_blank">
            üö∂‚Äç‚ôÇÔ∏è Shelter Route Navigation
        </a>
        <div class="status">
            ‚ú® Emergency Call button
        </div>
    </div>

    <script>
        // APIÎ°úÎ∂ÄÌÑ∞ Î∞õÏïÑÏò¨ Ïû¨ÎÇú Ï†ïÎ≥¥ (ÏûÑÏãú Îç∞Ïù¥ÌÑ∞)
        const getDisasterInfo = async () => {
            // TODO: Ïã§Ï†ú Ïû¨ÎÇúÎ¨∏Ïûê API Ïó∞Îèô Ïãú Ïù¥ Î∂ÄÎ∂ÑÏùÑ API Ìò∏Ï∂úÎ°ú ÎåÄÏ≤¥
            return {
                location: 'Seongdong-gu, Seoul',
                type: 'earthquake',
                scale: 'Magnitude 3.5',
                time: '14:23',
                coordinates: {
                    lat: 37.563456,  // ÏÑ±ÎèôÍµ¨ ÌñâÎãπÎèô Î∂ÄÍ∑º
                    lng: 127.036372
                },
                radius: 5000  // ÏúÑÌóò Î∞òÍ≤Ω (ÎØ∏ÌÑ∞)
            };
        };

        // APIÎ°úÎ∂ÄÌÑ∞ Î∞õÏïÑÏò¨ ÎåÄÌîºÏÜå Ï†ïÎ≥¥ (ÏûÑÏãú Îç∞Ïù¥ÌÑ∞)
        const getShelterInfo = async () => {
            // TODO: Ïã§Ï†ú Ïû¨ÎÇúÎåÄÌîºÏÜå API Ïó∞Îèô Ïãú Ïù¥ Î∂ÄÎ∂ÑÏùÑ API Ìò∏Ï∂úÎ°ú ÎåÄÏ≤¥
            return {
                id: "S001",
                name: "Seongdong District Office",
                type: "Emergency Shelter",
                address: "39 Wangsan-ro, Seongdong-gu, Seoul",
                lat: 37.563456,  // ÏÑ±ÎèôÍµ¨Ï≤≠ Ï¢åÌëú
                lng: 127.036992
            };
        };

        // ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('current-time').textContent = `${hours}:${minutes}`;
        }
        
        updateCurrentTime();
        setInterval(updateCurrentTime, 60000);

        // Í±∞Î¶¨ Í≥ÑÏÇ∞ Ìï®Ïàò (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ÏúÑÏπò Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async function(position) {
                try {
                    // 1. ÌòÑÏû¨ ÏúÑÏπò Ï†ïÎ≥¥
                    const currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    console.log('Current Location:', currentLocation);

                    // 2. APIÏóêÏÑú Ïû¨ÎÇú Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                    const disasterInfo = await getDisasterInfo();
                    console.log('Disaster Info:', disasterInfo);
                    
                    // 3. APIÏóêÏÑú Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÎåÄÌîºÏÜå Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                    const shelterInfo = await getShelterInfo();
                    console.log('Shelter Info:', shelterInfo);

                    // 4. ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî
                    const map = new naver.maps.Map('map', {
                        center: new naver.maps.LatLng(currentLocation.lat, currentLocation.lng),
                        zoom: 13,
                        scaleControl: true,
                        mapDataControl: true,
                        zoomControl: true,
                        mapTypeControl: true,
                        language: 'en'
                    });

                    // 5. ÌòÑÏû¨ ÏúÑÏπò ÎßàÏª§
                    const currentMarker = new naver.maps.Marker({
                        position: new naver.maps.LatLng(currentLocation.lat, currentLocation.lng),
                        map: map,
                        icon: {
                            content: `
                                <div style="position:relative;cursor:pointer;" class="marker-container">
                                    <div style="position:absolute;bottom:0;left:50%;transform:translateX(-50%);">
                                        <div style="position:relative;width:24px;height:24px;">
                                            <div style="position:absolute;top:-36px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-top:16px solid #007AFF;"></div>
                                            <div style="position:absolute;top:-40px;left:50%;transform:translateX(-50%);width:12px;height:12px;background:#007AFF;border-radius:50%;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>
                                        </div>
                                    </div>
                                    <div class="info-window" style="background:white;border:2px solid #007AFF;color:#007AFF;position:absolute;white-space:nowrap;top:-80px;left:50%;transform:translateX(-50%);box-shadow:0 2px 6px rgba(0,0,0,0.2);padding:8px 12px;border-radius:6px;z-index:1;">
                                        üìç Current Location
                                    </div>
                                </div>
                            `
                        },
                        zIndex: 100
                    });

                    // 6. Ïû¨ÎÇú Î∞úÏÉù ÏßÄÏ†ê ÎßàÏª§
                    const disasterMarker = new naver.maps.Marker({
                        position: new naver.maps.LatLng(disasterInfo.coordinates.lat, disasterInfo.coordinates.lng),
                        map: map,
                        icon: {
                            content: `
                                <div style="position:relative;cursor:pointer;" class="marker-container">
                                    <div class="info-window" style="background:white;border:2px solid #FF3B30;color:#FF3B30;position:relative;box-shadow:0 2px 6px rgba(0,0,0,0.2);padding:8px 12px;border-radius:6px;z-index:1;">
                                        <div style="position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-top:10px solid #FF3B30;"></div>
                                        ‚ö†Ô∏è Disaster Point
                                    </div>
                                </div>
                            `
                        },
                        zIndex: 99
                    });

                    // 7. ÎåÄÌîºÏÜå ÎßàÏª§
                    const shelterMarker = new naver.maps.Marker({
                        position: new naver.maps.LatLng(shelterInfo.lat, shelterInfo.lng),
                        map: map,
                        icon: {
                            content: `
                                <div style="position:relative;cursor:pointer;" class="marker-container">
                                    <div class="info-window" style="background:white;border:2px solid #34C759;color:#34C759;position:relative;box-shadow:0 2px 6px rgba(0,0,0,0.2);padding:8px 12px;border-radius:6px;z-index:1;">
                                        <div style="position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-top:10px solid #34C759;"></div>
                                        üè• ${shelterInfo.name}
                                    </div>
                                </div>
                            `
                        },
                        zIndex: 98
                    });

                    // ÎßàÏª§ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
                    [currentMarker, disasterMarker, shelterMarker].forEach(marker => {
                        naver.maps.Event.addListener(marker, 'click', function() {
                            // ÌÅ¥Î¶≠Îêú ÎßàÏª§Î•º ÏµúÏÉÅÎã®ÏúºÎ°ú Ïò¨Î¶º
                            currentMarker.setZIndex(98);
                            disasterMarker.setZIndex(98);
                            shelterMarker.setZIndex(98);
                            marker.setZIndex(101);
                        });
                    });

                    // 8. ÏúÑÌóò Î∞òÍ≤Ω ÌëúÏãú
                    new naver.maps.Circle({
                        map: map,
                        center: new naver.maps.LatLng(disasterInfo.coordinates.lat, disasterInfo.coordinates.lng),
                        radius: disasterInfo.radius,
                        strokeWeight: 1,
                        strokeColor: '#FF3B30',
                        strokeOpacity: 0.7,
                        strokeStyle: 'solid',
                        fillColor: '#FF3B30',
                        fillOpacity: 0.15
                    });

                    // 9. ÏßÄÎèÑ ÏòÅÏó≠ ÏÑ§Ï†ï
                    const bounds = new naver.maps.LatLngBounds();
                    bounds.extend(new naver.maps.LatLng(currentLocation.lat, currentLocation.lng));
                    bounds.extend(new naver.maps.LatLng(disasterInfo.coordinates.lat, disasterInfo.coordinates.lng));
                    bounds.extend(new naver.maps.LatLng(shelterInfo.lat, shelterInfo.lng));
                    map.fitBounds(bounds, {
                        top: 100,
                        right: 100,
                        bottom: 100,
                        left: 100
                    });

                    // Ï¢åÌëúÎ•º Ï£ºÏÜåÎ°ú Î≥ÄÌôòÌïòÎäî Ìï®Ïàò
                    async function coordToAddress(lat, lng) {
                        const naver = window.naver;
                        return new Promise((resolve, reject) => {
                            naver.maps.Service.reverseGeocode({
                                coords: new naver.maps.LatLng(lat, lng),
                                orders: [
                                    naver.maps.Service.OrderType.ADDR,
                                    naver.maps.Service.OrderType.ROAD_ADDR
                                ].join(',')
                            }, function(status, response) {
                                if (status === naver.maps.Service.Status.ERROR) {
                                    reject('Ï£ºÏÜå Î≥ÄÌôò Ïã§Ìå®');
                                    return;
                                }
                                if (response.v2.address) {
                                    resolve(response.v2.address);
                                } else {
                                    reject('Ï£ºÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                                }
                            });
                        });
                    }

                    // REST APIÎ°ú Í≤ΩÎ°ú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                    async function getRouteData(start, goal) {
                        const url = 'https://maps.apigw.ntruss.com/map-direction/v1/driving';
                        const headers = {
                            'X-NCP-APIGW-API-KEY-ID': 'w5mst5owqn',
                            'X-NCP-APIGW-API-KEY': '155LxzbIokq7RvfMnBDdFNyeNS01gspCgCUyn1bz'
                        };
                        
                        try {
                            const response = await fetch(`${url}?start=${start.lng},${start.lat}&goal=${goal.lng},${goal.lat}&option=trafast`, {
                                method: 'GET',
                                headers: headers
                            });
                            
                            if (!response.ok) {
                                const errorData = await response.json();
                                console.error('Direction API Error Response:', errorData);
                                throw new Error(`Direction API request failed: ${response.status}`);
                            }
                            
                            const data = await response.json();
                            console.log('Route Data:', data);
                            
                            if (!data.route || !data.route.trafast || !data.route.trafast[0]) {
                                throw new Error('Invalid route data structure');
                            }
                            
                            return data;
                        } catch (error) {
                            console.error('Direction API Error:', error);
                            throw error;
                        }
                    }

                    // Í≤ΩÎ°úÎ•º ÏßÄÎèÑÏóê Í∑∏Î¶¨Í∏∞
                    function drawRoute(map, path) {
                        return new naver.maps.Polyline({
                            map: map,
                            path: path,
                            strokeColor: '#5347AA',
                            strokeWeight: 5,
                            strokeOpacity: 0.8,
                            strokeStyle: 'solid'
                        });
                    }

                    let currentPath = null;

                    // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î≤ÑÌäº ÏÑ§Ï†ï
                    document.getElementById('goBtn').addEventListener('click', async function (e) {
                        e.preventDefault();

                        const directionsService = new naver.maps.DirectionsService();

                        const start = new naver.maps.LatLng(currentLocation.lat, currentLocation.lng);
                        const end = new naver.maps.LatLng(shelterInfo.lat, shelterInfo.lng);

                        // Í≤ΩÎ°ú ÏöîÏ≤≠
                        directionsService.route({
                            start: start,
                            goal: end,
                            option: 'trafast' // Îπ†Î•∏ Í∏∏ Í∏∞Ï§Ä. ÌïÑÏöîÏóê Îî∞Îùº trafast / tracomfort Îì± Î≥ÄÍ≤Ω Í∞ÄÎä•
                        }, function (status, response) {
                            if (status !== naver.maps.DirectionsStatus.OK) {
                                return alert('Í≤ΩÎ°úÎ•º Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                            }

                            const route = response.route[0]; // Ï≤´ Î≤àÏß∏ Í≤ΩÎ°ú
                            const path = route.path.map(coord => new naver.maps.LatLng(coord[1], coord[0]));

                            // Í∏∞Ï°¥ Í≤ΩÎ°úÍ∞Ä ÏûàÎã§Î©¥ Ï†úÍ±∞ (optional)
                            if (window.routePolyline) {
                                window.routePolyline.setMap(null);
                            }

                            // Í≤ΩÎ°ú ÎùºÏù∏ ÏÉùÏÑ±
                            window.routePolyline = new naver.maps.Polyline({
                                path: path,
                                strokeColor: '#007AFF',
                                strokeOpacity: 0.8,
                                strokeWeight: 6,
                                map: map
                            });

                            // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî ÎåÄÏã† Î™©Ï†ÅÏßÄ info Ï∂úÎ†• Îì±ÎèÑ Í∞ÄÎä•
                            document.getElementById('goBtn').textContent = '‚úÖ Route Displayed';
                            document.getElementById('goBtn').style.backgroundColor = '#28a745';
                        });
                    });
                    const goBtn = document.getElementById('goBtn'); // goBtn Î≥ÄÏàò ÏÑ†Ïñ∏ Ï∂îÍ∞Ä
                    goBtn.style.display = 'block';

                    // 11. 3Ï¥à ÌõÑ ÎåÄÌîºÏÜå Î∞©Ìñ•ÏúºÎ°ú ÏßÄÎèÑ Ï†ÑÌôò
                    setTimeout(() => {
                        const centerLat = (currentLocation.lat + shelterInfo.lat) / 2;
                        const centerLng = (currentLocation.lng + shelterInfo.lng) / 2;
                        
                        map.morph(new naver.maps.LatLng(centerLat, centerLng), 15, {
                            duration: 2000,
                            easing: 'easeOutCubic'
                        });

                        document.querySelector('.status').textContent = 
                            '‚ú® Please check the safe route to the nearest shelter.';
                    }, 3000);

                    // 12. Í±∞Î¶¨ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                    const distanceToDisaster = calculateDistance(
                        currentLocation.lat,
                        currentLocation.lng,
                        disasterInfo.coordinates.lat,
                        disasterInfo.coordinates.lng
                    ).toFixed(1);
                    
                    document.getElementById('disaster-distance').textContent = `${distanceToDisaster}km`;
                    document.getElementById('disaster-location').textContent = disasterInfo.location;
                    document.getElementById('disaster-type').textContent = disasterInfo.type;

                } catch (error) {
                    console.error('Error:', error);
                    alert('Error loading disaster or shelter information.');
                }
            }, function(error) {
                alert('Cannot get your location. Please check your location permission settings.');
            });
        } else {
            alert('Geolocation is not supported by this browser.');
        }
    </script>
</body>
</html> 