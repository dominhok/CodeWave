<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Evacuation Route</title>
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=w5mst5owqn&submodules=geocoder&language=en"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: #343a40;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(0, 122, 255, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(0, 122, 255, 0.2);
        }

        .header h1 {
            font-size: 2.2em;
            color: #007AFF;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
            font-weight: 500;
            margin-bottom: 0;
            line-height: 1.4;
        }

        .header p strong {
            color: #007AFF;
            font-weight: 600;
        }

        .emergency-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 1em;
            color: #555;
        }

        .emergency-info span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #map {
            width: 100%;
            height: 500px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        #goBtn {
            display: none;
            width: 100%;
            padding: 18px 20px;
            font-size: 1.3em;
            color: white;
            background-color: #007AFF;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: all 0.3s;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.2);
            font-weight: 700;
        }

        #goBtn:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .status {
            margin-top: 20px;
            padding: 18px;
            background: white;
            border-radius: 8px;
            font-size: 1.1em;
            color: #666;
            border: 1px solid #e9ecef;
            font-weight: 500;
        }

        .emergency-alert {
            background: #007AFF;
            color: white;
            padding: 14px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1em;
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.2);
            letter-spacing: -0.3px;
        }

        .emergency-alert span {
            margin-right: 12px;
            font-size: 1.2em;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        #goBtn {
            animation: pulse 2s infinite;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .header h1 {
                font-size: 2em;
            }
            #map {
                height: 50vh;
            }
            #goBtn {
                font-size: 1.2em;
                padding: 16px 20px;
            }
            .emergency-alert {
                font-size: 1em;
                padding: 14px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® Emergency Evacuation Route</h1>
            <p>A <strong id="disaster-type">earthquake</strong> has occurred in <strong id="disaster-location">Gangnam-gu, Seoul</strong>.<br></p>
            <div class="emergency-info">
                <span>üïí <span id="current-time">--:--</span></span>
                <span>üìç Distance from current location: <span id="disaster-distance">3.7km</span></span>
            </div>
        </div>
        <div class="emergency-alert">
            <span>‚ö° Guiding you to the nearest safe shelter from your current location</span>
        </div>
        <div id="map"></div>
        <a id="goBtn" href="#" target="_blank">
            üö∂‚Äç‚ôÇÔ∏è Shelter Route Navigation
        </a>
        <div class="status">
            ‚ú® Emergency Call button
        </div>
    </div>

    <script>
        // APIÎ°úÎ∂ÄÌÑ∞ Î∞õÏïÑÏò¨ Ïû¨ÎÇú Ï†ïÎ≥¥ (ÏûÑÏãú Îç∞Ïù¥ÌÑ∞)
        const getDisasterInfo = async () => {
            // TODO: Ïã§Ï†ú Ïû¨ÎÇúÎ¨∏Ïûê API Ïó∞Îèô Ïãú Ïù¥ Î∂ÄÎ∂ÑÏùÑ API Ìò∏Ï∂úÎ°ú ÎåÄÏ≤¥
            return {
                location: 'Seongdong-gu, Seoul',
                type: 'earthquake',
                scale: 'Magnitude 3.5',
                time: '14:23',
                coordinates: {
                    lat: 37.563456,  // ÏÑ±ÎèôÍµ¨ ÌñâÎãπÎèô Î∂ÄÍ∑º
                    lng: 127.036372
                },
                radius: 5000  // ÏúÑÌóò Î∞òÍ≤Ω (ÎØ∏ÌÑ∞)
            };
        };

        // APIÎ°úÎ∂ÄÌÑ∞ Î∞õÏïÑÏò¨ ÎåÄÌîºÏÜå Ï†ïÎ≥¥ (ÏûÑÏãú Îç∞Ïù¥ÌÑ∞)
        const getShelterInfo = async () => {
            // TODO: Ïã§Ï†ú Ïû¨ÎÇúÎåÄÌîºÏÜå API Ïó∞Îèô Ïãú Ïù¥ Î∂ÄÎ∂ÑÏùÑ API Ìò∏Ï∂úÎ°ú ÎåÄÏ≤¥
            return {
                id: "S001",
                name: "Seongdong District Office",
                type: "Emergency Shelter",
                address: "39 Wangsan-ro, Seongdong-gu, Seoul",
                lat: 37.5513455,  // ÏÑ±ÎèôÍµ¨Ï≤≠ Ï¢åÌëú
                lng: 127.0726955
            };
        };

        // ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('current-time').textContent = `${hours}:${minutes}`;
        }
        
        updateCurrentTime();
        setInterval(updateCurrentTime, 60000);

        // Í±∞Î¶¨ Í≥ÑÏÇ∞ Ìï®Ïàò (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ÏúÑÏπò Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async function(position) {
                try {
                    // 1. ÌòÑÏû¨ ÏúÑÏπò Ï†ïÎ≥¥
                    const currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    console.log('Current Location:', currentLocation);

                    // 2. APIÏóêÏÑú Ïû¨ÎÇú Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                    const disasterInfo = await getDisasterInfo();
                    console.log('Disaster Info:', disasterInfo);
                    
                    // 3. APIÏóêÏÑú Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÎåÄÌîºÏÜå Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                    const shelterInfo = await getShelterInfo();
                    console.log('Shelter Info:', shelterInfo);

                    // 4. ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî
                    const map = new naver.maps.Map('map', {
                        center: new naver.maps.LatLng(currentLocation.lat, currentLocation.lng),
                        zoom: 13,
                        scaleControl: true,
                        mapDataControl: true,
                        zoomControl: true,
                        mapTypeControl: true,
                        language: 'en'
                    });

                    // 5. ÌòÑÏû¨ ÏúÑÏπò ÎßàÏª§
                    const currentMarker = new naver.maps.Marker({
                        position: new naver.maps.LatLng(currentLocation.lat, currentLocation.lng),
                        map: map,
                        title: 'Current Location',
                        zIndex: 100
                    });

                    // 6. Ïû¨ÎÇú Î∞úÏÉù ÏßÄÏ†ê ÎßàÏª§
                    const disasterMarker = new naver.maps.Marker({
                        position: new naver.maps.LatLng(disasterInfo.coordinates.lat, disasterInfo.coordinates.lng),
                        map: map,
                        title: 'Disaster Point',
                        zIndex: 99
                    });

                    // 7. ÎåÄÌîºÏÜå ÎßàÏª§
                    const shelterMarker = new naver.maps.Marker({
                        position: new naver.maps.LatLng(shelterInfo.lat, shelterInfo.lng),
                        map: map,
                        visible: false,
                        title: `Shelter: ${shelterInfo.name}`,
                        icon: {
                            url: '/static/img/shelter.png',
                            size: new naver.maps.Size(36, 36),
                            origin: new naver.maps.Point(0, 0),
                            anchor: new naver.maps.Point(18, 36)
                        },
                        zIndex: 98
                    });

                    // ÎßàÏª§ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
                    [currentMarker, disasterMarker, shelterMarker].forEach(marker => {
                        naver.maps.Event.addListener(marker, 'click', function() {
                            // ÌÅ¥Î¶≠Îêú ÎßàÏª§Î•º ÏµúÏÉÅÎã®ÏúºÎ°ú Ïò¨Î¶º
                            currentMarker.setZIndex(98);
                            disasterMarker.setZIndex(98);
                            shelterMarker.setZIndex(98);
                            marker.setZIndex(101);
                        });
                    });

                    // 8. ÏúÑÌóò Î∞òÍ≤Ω ÌëúÏãú
                    const disasterCircle = new naver.maps.Circle({
                        map: map,
                        center: new naver.maps.LatLng(disasterInfo.coordinates.lat, disasterInfo.coordinates.lng),
                        radius: disasterInfo.radius,
                        strokeWeight: 1,
                        strokeColor: '#FF3B30',
                        strokeOpacity: 0.7,
                        strokeStyle: 'solid',
                        fillColor: '#FF3B30',
                        fillOpacity: 0.15
                    });

                    // 9. ÏßÄÎèÑ ÏòÅÏó≠ ÏÑ§Ï†ï - Ï≤òÏùåÏóêÎäî Ïû¨ÎÇú Î∞òÍ≤ΩÏùÑ Ï§ëÏã¨ÏúºÎ°ú ÏÑ§Ï†ï
                    const initialBounds = new naver.maps.LatLngBounds(
                        new naver.maps.LatLng(
                            disasterInfo.coordinates.lat - disasterInfo.radius / 111000 * 1.2, // ÎÇ®Ï™Ω Í≤ΩÍ≥Ñ (ÏïΩÍ∞Ñ Ïó¨Ïú† Ï∂îÍ∞Ä)
                            disasterInfo.coordinates.lng - disasterInfo.radius / (111000 * Math.cos(disasterInfo.coordinates.lat * Math.PI / 180)) * 1.2 // ÏÑúÏ™Ω Í≤ΩÍ≥Ñ
                        ),
                        new naver.maps.LatLng(
                            disasterInfo.coordinates.lat + disasterInfo.radius / 111000 * 1.2, // Î∂ÅÏ™Ω Í≤ΩÍ≥Ñ
                            disasterInfo.coordinates.lng + disasterInfo.radius / (111000 * Math.cos(disasterInfo.coordinates.lat * Math.PI / 180)) * 1.2 // ÎèôÏ™Ω Í≤ΩÍ≥Ñ
                        )
                    );
                    
                    // Ïû¨ÎÇú Î∞òÍ≤ΩÏù¥ ÍΩâ Ï∞®ÎèÑÎ°ù ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî
                    map.fitBounds(initialBounds);

                    // Ïû¨ÎÇú Î∞òÍ≤ΩÏóê Îî∞Î•∏ Ï†ÅÏ†àÌïú Ï§å Î†àÎ≤® Í≥ÑÏÇ∞ Ìï®Ïàò
                    const calculateZoomFromRadius = (radius) => {
                        // Î∞òÍ≤ΩÏóê Îî∞Î•∏ Ï§å Î†àÎ≤® Í≥ÑÏÇ∞ (Î∞òÍ≤ΩÏù¥ ÌÅ¥ÏàòÎ°ù Ï§å Î†àÎ≤®ÏùÄ ÏûëÏïÑÏßê)
                        // 1km = ÏïΩ Ï§åÎ†àÎ≤® 14, 5km = ÏïΩ Ï§åÎ†àÎ≤® 12, 10km = ÏïΩ Ï§åÎ†àÎ≤® 10
                        const baseZoom = 15; // Í∏∞Ï§Ä Ï§å Î†àÎ≤®
                        const radiusInKm = radius / 1000;
                        
                        // Î°úÍ∑∏ Ïä§ÏºÄÏùºÎ°ú Ï§å Î†àÎ≤® Í≥ÑÏÇ∞ (Î∞òÍ≤ΩÏù¥ Ïª§ÏßàÏàòÎ°ù Îçî ÎßéÏù¥ Ï§åÏïÑÏõÉ)
                        const zoomAdjustment = Math.log2(radiusInKm) * 1.5;
                        const calculatedZoom = baseZoom - zoomAdjustment;
                        
                        // Ï§å Î†àÎ≤® Î≤îÏúÑ Ï†úÌïú (ÏµúÏÜå 7, ÏµúÎåÄ 18)
                        return Math.min(Math.max(Math.round(calculatedZoom), 7), 18);
                    };
                    
                    // Ïû¨ÎÇú Î∞òÍ≤ΩÏóê Îî∞Î•∏ Ï§å Î†àÎ≤® Í≥ÑÏÇ∞
                    const disasterBasedZoom = calculateZoomFromRadius(disasterInfo.radius);
                    console.log("Disaster-based zoom level:", disasterBasedZoom);

                    // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î≤ÑÌäº ÏÑ§Ï†ï
                    document.getElementById('goBtn').addEventListener('click', function (e) {
                        e.preventDefault();

                        // ÌòÑÏû¨ ÏúÑÏπòÏôÄ ÎåÄÌîºÏÜå Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ (ÎèôÏ†Å Í∞í ÏÇ¨Ïö©)
                        const startLat = currentLocation.lat;
                        const startLng = currentLocation.lng;
                        const goalLat = shelterInfo.lat;
                        const goalLng = shelterInfo.lng;
                        const goalName = shelterInfo.name;

                        // Naver ÏßÄÎèÑ Í∏∏Ï∞æÍ∏∞ URL ÏÉùÏÑ± (Í≤ΩÎ°ú ÌååÎùºÎØ∏ÌÑ∞ ÏÇ¨Ïö©)
                        const startNameEncoded = encodeURIComponent('Current Location');
                        const goalNameEncoded = encodeURIComponent(goalName);

                        // Lng, Lat ÏàúÏÑú ÌôïÏù∏
                        const naverMapUrl = `https://map.naver.com/v5/directions/${startLng},${startLat},${startNameEncoded}/${goalLng},${goalLat},${goalNameEncoded}/-/walk`; // ÎèÑÎ≥¥ Í≤ΩÎ°ú Í∏∞Î≥∏ ÏßÄÏ†ï

                        console.log("Naver Map URL:", naverMapUrl); // ÏÉùÏÑ±Îêú URL ÌôïÏù∏Ïö© Î°úÍ∑∏

                        // ÏÉà ÌÉ≠ÏóêÏÑú Naver ÏßÄÎèÑ Í∏∏Ï∞æÍ∏∞ Ïó¥Í∏∞
                        window.open(naverMapUrl, '_blank');

                    });
                    const goBtn = document.getElementById('goBtn'); // goBtn Î≥ÄÏàò ÏÑ†Ïñ∏ Ï∂îÍ∞Ä
                    goBtn.style.display = 'block';

                    // 11. 3Ï¥à ÌõÑ ÎåÄÌîºÏÜå Î∞©Ìñ•ÏúºÎ°ú ÏßÄÎèÑ Ï†ÑÌôò
                    setTimeout(() => {
                        // ÌòÑÏû¨ ÏúÑÏπòÏôÄ ÎåÄÌîºÏÜå ÏÇ¨Ïù¥Ïùò Ï§ëÍ∞Ñ ÏßÄÏ†ê Í≥ÑÏÇ∞
                        const centerLat = (currentLocation.lat + shelterInfo.lat) / 2;
                        const centerLng = (currentLocation.lng + shelterInfo.lng) / 2;
                        
                        // ÎåÄÌîºÏÜå ÎßàÏª§ ÌëúÏãú
                        shelterMarker.setVisible(true);
                        
                        // Í≤ΩÎ°úÍ∞Ä Î≥¥Ïù¥Îäî Í≤ΩÍ≥Ñ ÏÑ§Ï†ï (ÌòÑÏû¨ ÏúÑÏπòÏôÄ ÎåÄÌîºÏÜåÎ•º Î™®Îëê Ìè¨Ìï®ÌïòÍ≥† ÏïΩÍ∞ÑÏùò Ïó¨Ïú† Í≥µÍ∞Ñ)
                        const routeBounds = new naver.maps.LatLngBounds();
                        routeBounds.extend(new naver.maps.LatLng(currentLocation.lat, currentLocation.lng));
                        routeBounds.extend(new naver.maps.LatLng(shelterInfo.lat, shelterInfo.lng));
                        
                        // Î™®Î∞îÏùºÏóêÏÑú Ïûò Î≥¥Ïù¥ÎèÑÎ°ù Ïó¨Î∞± Ï∂îÍ∞Ä
                        routeBounds.extend(new naver.maps.LatLng(
                            Math.min(currentLocation.lat, shelterInfo.lat) - 0.003,
                            Math.min(currentLocation.lng, shelterInfo.lng) - 0.003
                        ));
                        routeBounds.extend(new naver.maps.LatLng(
                            Math.max(currentLocation.lat, shelterInfo.lat) + 0.003,
                            Math.max(currentLocation.lng, shelterInfo.lng) + 0.003
                        ));
                        
                        // Î∂ÄÎìúÎü¨Ïö¥ Ï†ÑÌôòÏùÑ ÏúÑÌï¥ morph ÏÇ¨Ïö© - Ï§ëÍ∞Ñ ÏßÄÏ†êÏúºÎ°ú Ïù¥Îèô ÌõÑ Ï†ÅÏ†àÌïú Ï§å Î†àÎ≤® Ï†ÅÏö©
                        // disasterBasedZoomÎ≥¥Îã§ ÏïΩÍ∞Ñ Îçî ÌôïÎåÄ(+2)ÌïòÏó¨ Í≤ΩÎ°úÎ•º Ïûò Î≥¥Ïù¥Í≤å Ìï®
                        const routeZoom = disasterBasedZoom + 2;
                        console.log("Route zoom level:", routeZoom);
                        
                        map.morph(new naver.maps.LatLng(centerLat, centerLng), routeZoom, {
                            duration: 2500, // Ï†ÑÌôò ÏãúÍ∞Ñ (ms)
                            easing: 'easeOutCubic' // Î∂ÄÎìúÎü¨Ïö¥ Ï†ÑÌôòÏùÑ ÏúÑÌïú easing Ìï®Ïàò
                        });
                        
                        // Í≤ΩÎ°úÍ∞Ä Î≥¥Ïù¥ÎèÑÎ°ù bounds Ï†ÅÏö© (ÌïÑÏöîÌïú Í≤ΩÏö∞ÏóêÎßå)
                        setTimeout(() => {
                            // ÌòÑÏû¨ Î≥¥Ïù¥Îäî ÏòÅÏó≠Ïóê Í≤ΩÎ°úÍ∞Ä Î™®Îëê Ìè¨Ìï®ÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
                            const currentBounds = map.getBounds();
                            if (!currentBounds.hasLatLng(new naver.maps.LatLng(currentLocation.lat, currentLocation.lng)) || 
                                !currentBounds.hasLatLng(new naver.maps.LatLng(shelterInfo.lat, shelterInfo.lng))) {
                                map.fitBounds(routeBounds, {
                                    top: 50,
                                    right: 50,
                                    bottom: 50,
                                    left: 50
                                });
                            }
                        }, 2600); // Ï≤´ Î≤àÏß∏ transitionÏù¥ ÎÅùÎÇú ÌõÑ bounds ÌôïÏù∏

                        document.querySelector('.status').textContent = 
                            '‚ú® Please check the safe route to the nearest shelter.';
                    }, 3000);

                    // 12. Í±∞Î¶¨ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                    const distanceToDisaster = calculateDistance(
                        currentLocation.lat,
                        currentLocation.lng,
                        disasterInfo.coordinates.lat,
                        disasterInfo.coordinates.lng
                    ).toFixed(1);
                    
                    document.getElementById('disaster-distance').textContent = `${distanceToDisaster}km`;
                    document.getElementById('disaster-location').textContent = disasterInfo.location;
                    document.getElementById('disaster-type').textContent = disasterInfo.type;

                } catch (error) {
                    console.error('Error:', error);
                    alert('Error loading disaster or shelter information.');
                }
            }, function(error) {
                alert('Cannot get your location. Please check your location permission settings.');
            });
        } else {
            alert('Geolocation is not supported by this browser.');
        }
    </script>
</body>
</html> 