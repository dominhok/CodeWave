<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Emergency Evacuation Route</title>
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=w5mst5owqn&submodules=geocoder,directions&language=en"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f7f9fc;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    .header h1 {
      font-size: 1.8rem;
      color: #222;
      margin-bottom: 0.3rem;
    }

    .header p {
      margin: 0.5rem 0;
      color: #333;
    }

    .emergency-info {
      display: flex;
      justify-content: space-between;
      font-size: 0.95rem;
      margin-bottom: 1rem;
      color: #555;
    }

    .emergency-alert {
      background-color: #fffae6;
      border-left: 4px solid #ff9500;
      padding: 1rem;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 1rem;
    }

    #map {
      width: 100%;
      height: 400px;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 1rem;
    }

    #goBtn {
      display: none;
      text-decoration: none;
      background-color: #007aff;
      color: white;
      padding: 0.8rem 1.2rem;
      border-radius: 8px;
      font-size: 1rem;
      text-align: center;
      display: block;
      margin: 1rem auto;
      width: max-content;
    }

    .status {
      text-align: center;
      margin-top: 1rem;
      color: #888;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üö® Emergency Evacuation Route</h1>
      <p>
        A <strong id="disaster-type">earthquake</strong> has occurred in 
        <strong id="disaster-location">Gangnam-gu, Seoul</strong>.<br>
      </p>
      <div class="emergency-info">
        <span>üïí <span id="current-time">--:--</span></span>
        <span>üìç Distance from current location: <span id="disaster-distance">--km</span></span>
      </div>
    </div>
    <div class="emergency-alert">
      ‚ö° Guiding you to the nearest safe shelter from your current location
    </div>
    <div id="map"></div>
    <a id="goBtn" href="#" target="_blank">üö∂‚Äç‚ôÇÔ∏è Shelter Route Navigation</a>
    <div class="status">‚ú® Emergency Call button</div>
  </div>

  <script>
    async function getDisasterInfo() {
      try {
        const response = await fetch('https://example.com/disaster/latest');
        const data = await response.json();
        return {
          location: data.locationName,
          type: data.disasterType,
          scale: data.scale,
          time: data.occurredTime,
          coordinates: {
            lat: data.latitude,
            lng: data.longitude
          },
          radius: data.dangerRadius || 5000
        };
      } catch (error) {
        console.error('Ïû¨ÎÇú Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
        return {
          location: 'Unknown',
          type: 'earthquake',
          scale: 'Unknown',
          time: 'Unknown',
          coordinates: {
            lat: 37.5665,
            lng: 126.9780
          },
          radius: 5000
        };
      }
    }

    async function getShelterInfo(currentLat, currentLng) {
      try {
        const response = await fetch(`https://apis.data.go.kr/1741000/ShelterList/getShelterList?serviceKey=84AQ12TV0KFI2163&pageNo=1&numOfRows=300&type=json`);
        const data = await response.json();
        const shelters = data.ShelterList?.row || [];

        let closest = null;
        let minDistance = Number.MAX_VALUE;

        shelters.forEach(shelter => {
          const distance = calculateDistance(currentLat, currentLng, parseFloat(shelter.lat), parseFloat(shelter.lng));
          if (distance < minDistance) {
            minDistance = distance;
            closest = shelter;
          }
        });

        return {
          id: closest.id,
          name: closest.shel_nm,
          type: closest.shel_div_type,
          address: closest.address,
          lat: parseFloat(closest.lat),
          lng: parseFloat(closest.lng)
        };
      } catch (error) {
        console.error('ÎåÄÌîºÏÜå Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
        return null;
      }
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = 
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function updateCurrentTime() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      document.getElementById('current-time').textContent = `${hours}:${minutes}`;
    }

    updateCurrentTime();
    setInterval(updateCurrentTime, 60000);

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(async function (position) {
        const currentLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };

        const disasterInfo = await getDisasterInfo();
        const shelterInfo = await getShelterInfo(currentLocation.lat, currentLocation.lng);

        document.getElementById('disaster-type').textContent = disasterInfo.type;
        document.getElementById('disaster-location').textContent = disasterInfo.location;

        const distanceToDisaster = calculateDistance(
          currentLocation.lat, currentLocation.lng,
          disasterInfo.coordinates.lat, disasterInfo.coordinates.lng
        ).toFixed(1);

        document.getElementById('disaster-distance').textContent = `${distanceToDisaster}km`;

        const map = new naver.maps.Map('map', {
          center: new naver.maps.LatLng(currentLocation.lat, currentLocation.lng),
          zoom: 13
        });

        new naver.maps.Marker({
          position: new naver.maps.LatLng(currentLocation.lat, currentLocation.lng),
          map: map,
          title: 'Current Location'
        });

        new naver.maps.Marker({
          position: new naver.maps.LatLng(disasterInfo.coordinates.lat, disasterInfo.coordinates.lng),
          map: map,
          title: 'Disaster Location',
          icon: {
            content: `<div style="background:#FF3B30;color:white;padding:5px 8px;border-radius:6px;font-weight:700;">‚ö†Ô∏è Disaster</div>`
          }
        });

        new naver.maps.Marker({
          position: new naver.maps.LatLng(shelterInfo.lat, shelterInfo.lng),
          map: map,
          title: 'Shelter Location',
          icon: {
            content: `<div style="background:#34C759;color:white;padding:5px 8px;border-radius:6px;font-weight:700;">üè† Shelter</div>`
          }
        });

        document.getElementById('goBtn').href = `https://map.naver.com/v5/directions/${currentLocation.lng},${currentLocation.lat},ÌòÑÏû¨ÏúÑÏπò,START/${shelterInfo.lng},${shelterInfo.lat},ÎåÄÌîºÏÜå,END?c=${currentLocation.lng},${currentLocation.lat},15,0,0,0,dh`;
        document.getElementById('goBtn').style.display = 'block';
      });
    }
  </script>
</body>
</html>
