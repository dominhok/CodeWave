<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>긴급 대피 경로</title>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=88db3da56ae5dd5f8fff37fe24e9852e&libraries=services"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: #343a40;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(0, 122, 255, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(0, 122, 255, 0.2);
        }

        .header h1 {
            font-size: 2.2em;
            color: #007AFF;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
            font-weight: 500;
            margin-bottom: 0;
            line-height: 1.4;
        }

        .header p strong {
            color: #007AFF;
            font-weight: 600;
        }

        .emergency-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 1em;
            color: #555;
        }

        .emergency-info span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #map {
            width: 100%;
            height: 500px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        .info-window {
            padding: 10px 16px;
            font-size: 15px;
            color: #343a40;
            background: white;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        #goBtn {
            display: none;
            width: 100%;
            padding: 18px 20px;
            font-size: 1.3em;
            color: white;
            background-color: #007AFF;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: all 0.3s;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.2);
            font-weight: 700;
        }

        #goBtn:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .status {
            margin-top: 20px;
            padding: 18px;
            background: white;
            border-radius: 8px;
            font-size: 1.1em;
            color: #666;
            border: 1px solid #e9ecef;
            font-weight: 500;
        }

        .emergency-alert {
            background: #007AFF;
            color: white;
            padding: 14px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1em;
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.2);
            letter-spacing: -0.3px;
        }

        .emergency-alert span {
            margin-right: 12px;
            font-size: 1.2em;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        #goBtn {
            animation: pulse 2s infinite;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .header h1 {
                font-size: 2em;
            }
            #map {
                height: 50vh;
            }
            #goBtn {
                font-size: 1.2em;
                padding: 16px 20px;
            }
            .emergency-alert {
                font-size: 1em;
                padding: 14px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚨 긴급 대피 경로</h1>
            <p><strong id="disaster-location">서울시 강남구</strong>에서 <strong id="disaster-type">지진</strong>이 발생하였습니다.<br></p>
            <div class="emergency-info">
                <span>🕒 <span id="current-time">--:--</span></span>
                <span>📍 현 위치와의 거리: <span id="disaster-distance">3.7km</span></span>
            </div>
        </div>
        <div class="emergency-alert">
            <span>⚡ 현재 위치에서 안전한 대피소까지 경로를 안내합니다</span>
        </div>
        <div id="map"></div>
        <a id="goBtn" href="#" target="_blank">
            🚶‍♂️ Shelter Route Navi
        </a>
        <div class="status">
            ✨ Emergency Call button
        </div>
    </div>

    <div id="loading">Loading location and shelter data...</div>

    <script>
        // Disaster information variables
        const disasterInfo = {
            location: '서울시 강남구',
            type: '지진',
            scale: '규모 3.5',
            time: '14:23',
            distance: '3.7km',
            coordinates: {  // 재난 발생 위치 좌표
                lat: 37.498095,
                lng: 127.027610
            },
            radius: 5000  // 위험 반경 (미터 단위)
        };

        // Update disaster information
        document.getElementById('disaster-location').textContent = disasterInfo.location;
        document.getElementById('disaster-type').textContent = disasterInfo.type;
        document.getElementById('disaster-distance').textContent = disasterInfo.distance;

        // Add current time update function
        function updateCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('current-time').textContent = `${hours}:${minutes}`;
        }
        
        // Update time immediately and every minute
        updateCurrentTime();
        setInterval(updateCurrentTime, 60000);

        const mapContainer = document.getElementById('map');
        const loadingIndicator = document.getElementById('loading');
        let map = null; // Declare map variable globally

        // Show loading indicator
        loadingIndicator.style.display = 'block';

        // Haversine distance calculation function
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        // Main function executed after getting location
        async function initializeMapAndLoadData(position) {
            const currentLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            console.log('Current Location:', currentLocation);

            // Calculate and display distance to disaster
            const distanceToDisaster = calculateDistance(
                currentLocation.lat, currentLocation.lng,
                disasterInfo.coordinates.lat, disasterInfo.coordinates.lng
            ).toFixed(1); // Format to 1 decimal place
            document.getElementById('disaster-distance').textContent = `${distanceToDisaster} km`;

            // 1. Initialize Kakao Map centered on current location
            const mapOption = {
                center: new kakao.maps.LatLng(currentLocation.lat, currentLocation.lng),
                level: 5 // Initial zoom level (adjust as needed)
            };
            map = new kakao.maps.Map(mapContainer, mapOption);

            // --- Marker Image Definitions (REMOVED) ---
            // const imageSize = new kakao.maps.Size(24, 35);
            // const redMarkerImage = new kakao.maps.MarkerImage(...);
            // const greenMarkerImage = new kakao.maps.MarkerImage(...);
            // -------------------------------------------

            // 2. Add Current Location Marker (uses default blue)
            const currentLatLng = new kakao.maps.LatLng(currentLocation.lat, currentLocation.lng);
            const currentMarker = new kakao.maps.Marker({ 
                position: currentLatLng, 
                map: map, 
                title: "Current Location" 
                // No custom image needed, uses default blue
            });
            const currentInfoWindow = new kakao.maps.InfoWindow({
                 content: '<div style="padding:5px; text-align: center;">You are here!</div>',
                 removable: true
             });
            kakao.maps.event.addListener(currentMarker, 'click', () => currentInfoWindow.open(map, currentMarker));
            currentInfoWindow.open(map, currentMarker); // <-- Show immediately

            // --- Pulsing Circle for Current Location ---
            let pulseRadius = 50; // Initial radius in meters
            let pulseCrescente = true; // Corrected variable name (camelCase)
            const pulseCircle = new kakao.maps.Circle({
                center : currentLatLng,
                radius: pulseRadius,
                strokeWeight: 1,
                strokeColor: '#007AFF',
                strokeOpacity: 0.5,
                strokeStyle: 'solid',
                fillColor: '#007AFF',
                fillOpacity: 0.1,
                zIndex: 1 // Ensure circle is below markers (optional)
            });
            pulseCircle.setMap(map);

            setInterval(() => {
                if (pulseCrescente) { // Use corrected variable name
                    pulseRadius += 10; // Increase radius
                    if (pulseRadius > 150) { // Max radius
                         pulseCrescente = false;
                    }
                } else {
                    pulseRadius -= 10; // Decrease radius
                    if (pulseRadius < 50) { // Min radius
                         pulseCrescente = true;
                    }
                }
                const opacity = 0.1 + ((pulseRadius - 50) / 100) * 0.1;
                pulseCircle.setOptions({ radius: pulseRadius, fillOpacity: opacity });
            }, 100); // Adjust interval for speed
            // -----------------------------------------

            // 3. Add Disaster Location Marker
            const disasterLatLng = new kakao.maps.LatLng(disasterInfo.coordinates.lat, disasterInfo.coordinates.lng);
            const disasterMarker = new kakao.maps.Marker({
                position: disasterLatLng,
                map: map,
                title: `Disaster: ${disasterInfo.type}`
                // REMOVED: image: redMarkerImage 
            });
             const disasterInfoWindow = new kakao.maps.InfoWindow({
                 content: `<div style="padding:5px; text-align: center; color: red;">⚠️ ${disasterInfo.type}</div>`,
                 removable: true
             });
            kakao.maps.event.addListener(disasterMarker, 'click', () => disasterInfoWindow.open(map, disasterMarker));
            disasterInfoWindow.open(map, disasterMarker); // <-- Show immediately

            // --- Danger Radius Circle (10km) ---
            const dangerCircle = new kakao.maps.Circle({
                center : disasterLatLng,  // Center on disaster location
                radius: 10000, // 10000 meters = 10 km
                strokeWeight: 1,
                strokeColor: '#FF0000', // Red stroke
                strokeOpacity: 0.5,
                strokeStyle: 'solid',
                fillColor: '#FF0000', // Red fill
                fillOpacity: 0.15, // Semi-transparent fill
                zIndex: 0 // Ensure circle is behind markers (optional)
            });
            dangerCircle.setMap(map);
            // -----------------------------------

            // 4. Call backend proxy to get shelters
            const range = 0.1; // Search range (degrees, approx 11km) - adjust if needed
            const startLat = currentLocation.lat - range;
            const endLat = currentLocation.lat + range;
            const startLot = currentLocation.lng - range;
            const endLot = currentLocation.lng + range;

            // Use the correct proxy endpoint defined in your FastAPI app
            const proxyUrl = `/api/shelters_proxy?startLat=${startLat}&endLat=${endLat}&startLot=${startLot}&endLot=${endLot}`;
            console.log("Calling proxy:", proxyUrl);

            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) {
                     const errorData = await response.json();
                     throw new Error(`Proxy request failed: ${response.status} - ${JSON.stringify(errorData.detail || errorData)}`);
                }
                const data = await response.json();
                console.log("Proxy response:", data);

                if (data.header && data.header.resultCode !== '00') {
                    throw new Error(`API Error via Proxy: ${data.header.resultMsg} (${data.header.resultCode})`);
                }

                // 5. Find Closest Shelter
                let closestShelter = null;
                let minDistance = Infinity;

                if (data.body && data.body.length > 0) { // Check if body exists and has items
                    data.body.forEach(shelter => {
                        // Ensure LAT and LOT exist and are valid numbers
                        if (shelter.LAT && shelter.LOT && !isNaN(shelter.LAT) && !isNaN(shelter.LOT)) {
                            const shelterLat = parseFloat(shelter.LAT);
                            const shelterLng = parseFloat(shelter.LOT);
                            const distance = calculateDistance(currentLocation.lat, currentLocation.lng, shelterLat, shelterLng);

                            if (distance < minDistance) {
                                minDistance = distance;
                                closestShelter = {
                                    id: shelter.MNG_SN,
                                    name: shelter.REARE_NM,
                                    type: shelter.SHLT_SE_NM,
                                    address: shelter.RONA_DADDR,
                                    lat: shelterLat,
                                    lng: shelterLng,
                                    distance: distance // Store distance for info
                                };
                            }
                        } else {
                             console.warn("Skipping shelter with invalid coordinates:", shelter);
                        }
                    });
                     console.log("Closest shelter found:", closestShelter);
                } else {
                     console.log("No shelters found in the response body or body is empty.");
                }

                // 6. Add Closest Shelter Marker (only if found)
                let shelterMarker = null;
                let shelterLatLng = null; // Define shelterLatLng here
                if (closestShelter) {
                     shelterLatLng = new kakao.maps.LatLng(closestShelter.lat, closestShelter.lng); // Assign here
                     shelterMarker = new kakao.maps.Marker({
                        position: shelterLatLng,
                        map: map,
                        title: closestShelter.name
                        // REMOVED: image: greenMarkerImage 
                     });

                     // Add info window for the shelter
                     const shelterInfoWindow = new kakao.maps.InfoWindow({
                         content: `<div style="padding:5px;font-size:12px;"><strong>${closestShelter.name}</strong><br>Distance: ${closestShelter.distance.toFixed(2)} km</div>`,
                         removable: true
                     });
                     kakao.maps.event.addListener(shelterMarker, 'click', () => shelterInfoWindow.open(map, shelterMarker));
                     shelterInfoWindow.open(map, shelterMarker); // <-- Show immediately

                     // 7. Adjust Map Bounds to show all three markers (if shelter exists)
                     const bounds = new kakao.maps.LatLngBounds();
                     bounds.extend(currentLatLng);
                     bounds.extend(disasterLatLng); // Extend for disaster location
                     if (shelterLatLng) { // Only extend if shelter was found
                         bounds.extend(shelterLatLng);
                     }
                     map.setBounds(bounds);

                } else {
                    // No closest shelter found, maybe just center on current location
                    map.setCenter(currentLatLng);
                    map.setLevel(5); // Or your preferred zoom level
                    alert("No nearby shelters found based on the available data.");
                }

            } catch (error) {
                 console.error("Error fetching or processing shelter data:", error);
                 alert(`Failed to load shelter data: ${error.message}`);
                 // Keep map centered on current location even if shelters fail
                 map.setCenter(currentLatLng);
                 map.setLevel(5);
            } finally {
                 // Hide loading indicator regardless of outcome
                loadingIndicator.style.display = 'none';
            }
        }

        // Function to handle geolocation errors
        function handleLocationError(error) {
            console.warn(`Geolocation ERROR(${error.code}): ${error.message}`);
            loadingIndicator.style.display = 'none'; // Hide loading
            alert("Error: The Geolocation service failed or permission denied. Showing default map.");

            // Update UI to show failure
            document.getElementById('disaster-distance').textContent = "Location Unknown";

            // Initialize map with a default location (e.g., Seoul City Hall)
            const defaultLatLng = new kakao.maps.LatLng(37.566826, 126.9786567);
            const mapOption = {
                center: defaultLatLng,
                level: 7
            };
            map = new kakao.maps.Map(mapContainer, mapOption);
            // Optionally add a marker at the default location
             new kakao.maps.Marker({ position: defaultLatLng, map: map, title: "Default Location" });
        }

        // --- Execution Start ---
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(initializeMapAndLoadData, handleLocationError, {
                 enableHighAccuracy: true, // Optional: request more accurate location
                 timeout: 10000,         // Optional: time limit in milliseconds
                 maximumAge: 0           // Optional: force fresh location
             });
        } else {
            // Browser doesn't support Geolocation
            handleLocationError({ code: 0, message: "Geolocation is not supported by this browser." });
        }
    </script>
</body>
</html> 