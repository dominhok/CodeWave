<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Evacuation Route</title>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=3sl6kwcsrc"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: #f3eefc; /* Pink background tone */
            color: #264a39; /* Dark green text */
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
        }

        .header {
            text-align: center;
            margin-bottom: 10px;
            padding: 10px 15px;
            background: rgba(0, 134, 110, 0.1); /* Light green background */
            border-radius: 8px;
            border: 1px solid rgba(0, 134, 110, 0.2);
        }

        .header h1 {
            font-size: 1.3em;
            color: #00866e; /* Main green tone */
            margin-bottom: 5px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header p {
            color: #264a39; /* Dark green for text */
            font-size: 0.9em;
            font-weight: 500;
            margin-bottom: 0;
            line-height: 1.3;
        }

        .header p strong {
            color: #00866e; /* Main green tone */
            font-weight: 600;
        }

        .emergency-info {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 5px;
            font-size: 0.8em;
            color: #667a69; /* Lighter green for info */
        }

        .emergency-info span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        #map {
            width: 100%;
            height: 500px; /* Increased map height */
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(38, 74, 57, 0.1); /* Green shadow */
            border: 1px solid #f2eaf3; /* Light pink border */
        }

        .info-window {
            padding: 8px 12px;
            font-size: 13px;
            color: #264a39; /* Dark green text */
            background: #f3ebf5; /* Light pink background */
            border-radius: 6px;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #f2eaf3; /* Light pink border */
        }

        #goBtn {
            display: none;
            width: 100%;
            padding: 12px 16px;
            font-size: 1.1em;
            color: white;
            background-color: #00866e; /* Main green tone */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: all 0.3s;
            margin-top: 10px;
            box-shadow: 0 4px 8px rgba(0, 134, 110, 0.2); /* Green shadow */
            font-weight: 700;
        }

        #goBtn:hover {
            background-color: #264a39; /* Darker green on hover */
            transform: translateY(-1px);
        }

        #emergencyInfoBtn {
            display: none; 
            width: 100%; 
            padding: 12px 16px; 
            font-size: 1.1em; 
            color: white; 
            background-color: #748C78; /* Another green tone */
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            margin-top: 10px; 
            box-shadow: 0 4px 8px rgba(116, 140, 120, 0.2); /* Green shadow */
            font-weight: 700;
        }
        
        #emergencyInfoBtn:hover {
            background-color: #667a69; /* Darker green on hover */
            transform: translateY(-1px);
        }

        .emergency-alert {
            background: #00866e; /* Main green tone */
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.8em;
            box-shadow: 0 4px 8px rgba(0, 134, 110, 0.2); /* Green shadow */
            letter-spacing: -0.3px;
        }

        .emergency-alert span {
            margin-right: 8px;
            font-size: 1.1em;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.01); }
            100% { transform: scale(1); }
        }

        #goBtn, #emergencyInfoBtn {
            animation: pulse 2s infinite;
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            .header h1 {
                font-size: 1.2em;
            }
            #map {
                height: 50vh; /* Increased for mobile */
                min-height: 350px; /* Minimum height increase */
            }
            #goBtn, #emergencyInfoBtn {
                font-size: 1em;
                padding: 12px 15px;
            }
            .emergency-alert {
                font-size: 0.8em;
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        
        <div class="header">
            <h1>üö® Emergency Evacuation Route</h1>
            <p>A <strong id="disaster-type">earthquake</strong> has occurred in <strong id="disaster-location">Gangnam-gu, Seoul</strong>.<br></p>
            <div class="emergency-info">
                <span>üïí <span id="current-time">--:--</span></span>
                <span>üìç Distance from current location: <span id="disaster-distance">3.7km</span></span>
            </div>
        </div>
        <div class="emergency-alert">
            <span>‚ö° Please check the safe route to the nearest shelter from your current location</span>
        </div>
        <div id="map"></div>
        <a id="goBtn" href="#" target="_blank">
            üö∂‚Äç‚ôÇÔ∏è Shelter Route Navigation
        </a>
        <button id="emergencyInfoBtn">
            ‚ö†Ô∏è Emergency Information
        </button>
    </div>

    <script>
        
        let currentLocation = {
            lat: 37.563456,
            lng: 127.036372
        };
        // APIÎ°úÎ∂ÄÌÑ∞ Ïû¨ÎÇú Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        const getDisasterInfo = async () => {
            try {
                // URLÏóêÏÑú disaster_id Ï∂îÏ∂ú (path Í∏∞Î∞ò - /map/disaster_map/earthquake_gangnam)
                let disasterId = null;
                
                // URL Í≤ΩÎ°ú Î∂ÑÏÑù
                const pathSegments = window.location.pathname.split('/');
                // ÎßàÏßÄÎßâ ÏÑ∏Í∑∏Î®ºÌä∏Í∞Ä disaster_idÏù¥Î©¥ ÏÇ¨Ïö©
                // URL path ÌòïÏãù: /map/disaster_map/earthquake_gangnam
                if (pathSegments.length >= 4 && pathSegments[2] === 'disaster_map') {
                    disasterId = pathSegments[3];
                } else {
                    // Í∏∞Ï°¥ ÏøºÎ¶¨ ÌååÎùºÎØ∏ÌÑ∞ Î∞©ÏãùÎèÑ Î∞±ÏóÖÏúºÎ°ú ÏßÄÏõê
                    const urlParams = new URLSearchParams(window.location.search);
                    disasterId = urlParams.get('id');
                }
                
                // API ÏóîÎìúÌè¨Ïù∏Ìä∏ URL ÏÑ§Ï†ï (IDÍ∞Ä ÏûàÏúºÎ©¥ Ìï¥Îãπ ID ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í)
                const apiUrl = disasterId 
                    ? `/api/disaster/${disasterId}` 
                    : '/api/disaster/';
                
                console.log(`Fetching disaster info from: ${apiUrl}`);
                
                // API Ìò∏Ï∂ú
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                // JSON ÏùëÎãµ ÌååÏã±
                const data = await response.json();
                console.log('Disaster data:', data);
                
                // APIÏóêÏÑú Î∞õÏùÄ Îç∞Ïù¥ÌÑ∞ Î∞òÌôò
                return {
                    location: data.location,
                    type: data.type,
                    scale: data.scale || 'N/A',
                    time: data.time || '--:--',
                    coordinates: {
                        lat: data.coordinates.lat,
                        lng: data.coordinates.lng
                    },
                    radius: data.radius || 2000
                };
            } catch (error) {
                console.error('Error fetching disaster info:', error);
                // Ïò§Î•ò Î∞úÏÉù Ïãú Í∏∞Î≥∏Í∞í Î∞òÌôò
                return {
                    location: 'Unknown Location',
                    type: 'Unknown Disaster',
                    scale: 'N/A',
                    time: '--:--',
                    coordinates: { lat: 37.5665, lng: 126.9780 }, // Default to Seoul City Hall
                    radius: 2000
                };
            }
        };

        // APIÎ°úÎ∂ÄÌÑ∞ Î∞õÏïÑÏò¨ ÎåÄÌîºÏÜå Ï†ïÎ≥¥ (Flask ÌîÑÎ°ùÏãú ÏÇ¨Ïö©)
        const getShelterInfo = async (currentLocation) => {
            const range = 0.1; // You can adjust this range if needed
            const startLat = currentLocation.lat - range;
            const endLat = currentLocation.lat + range;
            const startLot = currentLocation.lng - range;
            const endLot = currentLocation.lng + range;

            // Call your Flask proxy route
            const proxyUrl = `/api/shelters_proxy?startLat=${startLat}&endLat=${endLat}&startLot=${startLot}&endLot=${endLot}`;

            console.log(`Fetching shelters via proxy: ${proxyUrl}`);

            try {
                // Fetch from your own server's proxy endpoint
                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    // Handle errors reported by your proxy (e.g., 400, 500, 502)
                    const errorData = await response.json();
                    throw new Error(`Proxy request failed: ${errorData.error || response.statusText}`);
                }
                const data = await response.json(); // Data is already parsed by Flask jsonify

                console.log('Shelter Proxy Response:', data);

                // The rest of the logic remains the same: check header, find closest, etc.
                if (data.header.resultCode !== '00') {
                    throw new Error(`API Error via Proxy: ${data.header.resultMsg} (${data.header.resultCode})`);
                }

                if (!data.body || data.totalCount === 0) {
                     console.warn('No shelters found in the vicinity via proxy.');
                     return null; // Return null if none found
                }

                let closestShelter = null;
                let minDistance = Infinity;

                data.body.forEach(shelter => {
                    const shelterLat = parseFloat(shelter.LAT);
                    const shelterLng = parseFloat(shelter.LOT);
                    // Ensure calculateDistance is defined correctly elsewhere in your script
                    const distance = calculateDistance(currentLocation.lat, currentLocation.lng, shelterLat, shelterLng);

                    if (distance < minDistance) {
                        minDistance = distance;
                        closestShelter = {
                            id: shelter.MNG_SN,
                            name: shelter.REARE_NM,
                            type: shelter.SHLT_SE_NM,
                            address: shelter.RONA_DADDR,
                            lat: shelterLat,
                            lng: shelterLng
                        };
                    }
                });

                 if (!closestShelter) {
                     console.warn('Could not determine closest shelter from proxy results.');
                     return null;
                 }

                console.log(`Closest shelter found via proxy: ${closestShelter.name} at ${minDistance.toFixed(2)}km`);
                return closestShelter;

            } catch (error) {
                console.error('Error fetching shelter info via proxy:', error);
                alert('Failed to fetch shelter information. Please try again later.');
                return null; // Return null on error
            }
        };

        // ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('current-time').textContent = `${hours}:${minutes}`;
        }
        
        updateCurrentTime();
        setInterval(updateCurrentTime, 60000);

        // Í±∞Î¶¨ Í≥ÑÏÇ∞ Ìï®Ïàò (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ÏúÑÏπò Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async function(position) {
                try {
                    // 1. ÌòÑÏû¨ ÏúÑÏπò Ï†ïÎ≥¥
                    currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    console.log('Current Location:', currentLocation);

                    // 2. APIÏóêÏÑú Ïû¨ÎÇú Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                    const disasterInfo = await getDisasterInfo();
                    console.log('Disaster Info:', disasterInfo);
                    
                    // 3. Î°úÏª¨ ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÎåÄÌîºÏÜå Í∞ÄÏ†∏Ïò§Í∏∞
                    const shelterInfo = await getShelterInfo(currentLocation); // Pass currentLocation again
                    console.log('Closest Shelter Info:', shelterInfo);

                    // 4. ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî
                    const map = new naver.maps.Map('map', {
                        center: new naver.maps.LatLng(currentLocation.lat, currentLocation.lng),
                        zoom: 13,
                        scaleControl: true,
                        mapDataControl: true,
                        zoomControl: true,
                        mapTypeControl: true,
                        language: 'en'
                    });

                    // 5. ÌòÑÏû¨ ÏúÑÏπò ÎßàÏª§
                    const currentMarker = new naver.maps.Marker({
                        position: new naver.maps.LatLng(currentLocation.lat, currentLocation.lng),
                        map: map,
                        icon: {
                            content: `
                                <div style="position:relative;cursor:pointer;" class="marker-container">
                                    <div style="position:absolute;bottom:0;left:50%;transform:translateX(-50%);">
                                        <div style="position:relative;width:24px;height:24px;">
                                            <div style="position:absolute;top:-14px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-top:16px solid #007AFF;"></div>
                                            <div style="position:absolute;top:-18px;left:50%;transform:translateX(-50%);width:12px;height:12px;background:#007AFF;border-radius:50%;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>
                                        </div>
                                    </div>
                                    <div class="info-window" style="background:white;border:2px solid #007AFF;color:#007AFF;position:absolute;white-space:nowrap;top:-58px;left:50%;transform:translateX(-50%);box-shadow:0 2px 6px rgba(0,0,0,0.2);padding:8px 12px;border-radius:6px;z-index:1;">
                                        üìç Current Location
                                    </div>
                                </div>
                            `
                        },
                        zIndex: 100
                    });

                    // 6. Ïû¨ÎÇú Î∞úÏÉù ÏßÄÏ†ê ÎßàÏª§
                    const disasterMarker = new naver.maps.Marker({
                        position: new naver.maps.LatLng(disasterInfo.coordinates.lat, disasterInfo.coordinates.lng),
                        map: map,
                        icon: {
                            content: `
                                <div style="position:relative;cursor:pointer;" class="marker-container">
                                    <div class="info-window" style="background:white;border:2px solid #FF3B30;color:#FF3B30;position:relative;box-shadow:0 2px 6px rgba(0,0,0,0.2);padding:8px 12px;border-radius:6px;z-index:1;">
                                        <div style="position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-top:10px solid #FF3B30;"></div>
                                        ‚ö†Ô∏è Disaster Point
                                    </div>
                                </div>
                            `,
                            anchor: new naver.maps.Point(75, 50) // Estimate: center-x, bottom-y + triangle height
                        },
                        zIndex: 99
                    });

                    // 7. Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÎåÄÌîºÏÜå ÎßàÏª§ ÏÉùÏÑ± (ÌïòÎÇòÎßå)
                    let shelterMarker = null; // Use let as it might be null
                    if (shelterInfo) { // Check if a closest shelter was found
                        shelterMarker = new naver.maps.Marker({
                            position: new naver.maps.LatLng(shelterInfo.lat, shelterInfo.lng),
                            map: map,
                            icon: {
                                content: `
                                    <div style="position:relative;cursor:pointer;" class="marker-container">
                                        <div class="info-window" style="background:white;border:2px solid #34C759;color:#34C759;position:relative;box-shadow:0 2px 6px rgba(0,0,0,0.2);padding:8px 12px;border-radius:6px;z-index:1;">
                                            <div style="position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-top:10px solid #34C759;"></div>
                                            üè• ${shelterInfo.name}
                                        </div>
                                    </div>
                                `,
                                anchor: new naver.maps.Point(100, 50) // Estimate: center-x, bottom-y + triangle height (wider for name)
                            },
                            zIndex: 98
                        });
                    } else {
                        console.log("No closest shelter found or dummy data empty.");
                    }

                    // ÎßàÏª§ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ ( shelterMarkerÍ∞Ä ÏûàÏùÑ Í≤ΩÏö∞ÏóêÎßå Ï∂îÍ∞Ä)
                    const markersToHandle = [currentMarker, disasterMarker];
                    if (shelterMarker) {
                        markersToHandle.push(shelterMarker);
                    }
                    markersToHandle.forEach(marker => {
                        naver.maps.Event.addListener(marker, 'click', function() {
                            // ÌÅ¥Î¶≠Îêú ÎßàÏª§Î•º ÏµúÏÉÅÎã®ÏúºÎ°ú Ïò¨Î¶º
                            markersToHandle.forEach(m => m.setZIndex(98)); // Reset others
                            marker.setZIndex(101); // Bring clicked to front
                        });
                    });

                    // 8. ÏúÑÌóò Î∞òÍ≤Ω ÌëúÏãú
                    new naver.maps.Circle({
                        map: map,
                        center: new naver.maps.LatLng(disasterInfo.coordinates.lat, disasterInfo.coordinates.lng),
                        radius: disasterInfo.radius,
                        strokeWeight: 1,
                        strokeColor: '#FF3B30',
                        strokeOpacity: 0.7,
                        strokeStyle: 'solid',
                        fillColor: '#FF3B30',
                        fillOpacity: 0.15
                    });

                    // 9. ÏßÄÎèÑ ÏòÅÏó≠ ÏÑ§Ï†ï (Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÎåÄÌîºÏÜå Ìè¨Ìï®)
                    const bounds = new naver.maps.LatLngBounds();
                    bounds.extend(new naver.maps.LatLng(currentLocation.lat, currentLocation.lng));
                    bounds.extend(new naver.maps.LatLng(disasterInfo.coordinates.lat, disasterInfo.coordinates.lng));
                    if (shelterMarker) { // Only extend if shelter marker exists
                        bounds.extend(shelterMarker.getPosition());
                    }

                    // Check if bounds are valid before fitting
                    map.fitBounds(bounds, {
                        top: 100,
                        right: 100,
                        bottom: 100,
                        left: 100
                    });

                    // Ï¢åÌëúÎ•º Ï£ºÏÜåÎ°ú Î≥ÄÌôòÌïòÎäî Ìï®Ïàò
                    async function coordToAddress(lat, lng) {
                        const naver = window.naver;
                        return new Promise((resolve, reject) => {
                            naver.maps.Service.reverseGeocode({
                                coords: new naver.maps.LatLng(lat, lng),
                                orders: [
                                    naver.maps.Service.OrderType.ADDR,
                                    naver.maps.Service.OrderType.ROAD_ADDR
                                ].join(',')
                            }, function(status, response) {
                                if (status === naver.maps.Service.Status.ERROR) {
                                    reject('Ï£ºÏÜå Î≥ÄÌôò Ïã§Ìå®');
                                    return;
                                }
                                if (response.v2.address) {
                                    resolve(response.v2.address);
                                } else {
                                    reject('Ï£ºÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                                }
                            });
                        });
                    }

                    // REST APIÎ°ú Í≤ΩÎ°ú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ - HTTPS ÌôïÏã§Ìûà ÏÇ¨Ïö©
                    async function getRouteData(start, goal) {
                        const url = 'https://maps.apigw.ntruss.com/map-direction/v1/driving';
                        const headers = {
                            'X-NCP-APIGW-API-KEY-ID': 'w5mst5owqn',
                            'X-NCP-APIGW-API-KEY': '155LxzbIokq7RvfMnBDdFNyeNS01gspCgCUyn1bz'
                        };
                        
                        try {
                            const response = await fetch(`${url}?start=${start.lng},${start.lat}&goal=${goal.lng},${goal.lat}&option=trafast`, {
                                method: 'GET',
                                headers: headers
                            });
                            
                            if (!response.ok) {
                                const errorData = await response.json();
                                console.error('Direction API Error Response:', errorData);
                                throw new Error(`Direction API request failed: ${response.status}`);
                            }
                            
                            const data = await response.json();
                            console.log('Route Data:', data);
                            
                            if (!data.route || !data.route.trafast || !data.route.trafast[0]) {
                                throw new Error('Invalid route data structure');
                            }
                            
                            return data;
                        } catch (error) {
                            console.error('Direction API Error:', error);
                            throw error;
                        }
                    }

                    // Í≤ΩÎ°úÎ•º ÏßÄÎèÑÏóê Í∑∏Î¶¨Í∏∞
                    function drawRoute(map, path) {
                        return new naver.maps.Polyline({
                            map: map,
                            path: path,
                            strokeColor: '#5347AA',
                            strokeWeight: 5,
                            strokeOpacity: 0.8,
                            strokeStyle: 'solid'
                        });
                    }

                    let currentPath = null;

                    // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î≤ÑÌäº ÏÑ§Ï†ï
                    const goBtn = document.getElementById('goBtn');
                    
                    goBtn.onclick = async function(e) {
                        e.preventDefault();
                        try {
                            // Ïù¥Ï†Ñ Í≤ΩÎ°úÍ∞Ä ÏûàÎã§Î©¥ ÏÇ≠Ï†ú
                            if (currentPath) {
                                currentPath.setMap(null);
                            }

                            // Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÎåÄÌîºÏÜå Ï†ïÎ≥¥ ÏÇ¨Ïö©
                            if (!shelterInfo) {
                                alert("Shelter information is not available to navigate.");
                                return;
                            }

                            console.log(`Navigating to closest shelter: ${shelterInfo.name}`);

                            // REST APIÎ°ú Í≤ΩÎ°ú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÎåÄÌîºÏÜå Í∏∞Ï§Ä)
                            const routeData = await getRouteData(
                                { lat: currentLocation.lat, lng: currentLocation.lng },
                                { lat: shelterInfo.lat, lng: shelterInfo.lng } // Use the single closest shelter info
                            );

                            if (routeData && routeData.route && routeData.route.trafast && routeData.route.trafast[0] && routeData.route.trafast[0].path) {
                                // Í≤ΩÎ°ú Ï¢åÌëú Î≥ÄÌôò
                                const pathCoords = routeData.route.trafast[0].path;
                                const path = [];
                                
                                // Ï¢åÌëú Î∞∞Ïó¥ÏùÑ LatLng Í∞ùÏ≤¥Î°ú Î≥ÄÌôò
                                for (let i = 0; i < pathCoords.length; i++) {
                                    path.push(new naver.maps.LatLng(pathCoords[i][1], pathCoords[i][0]));
                                }
                                
                                // Í≤ΩÎ°ú Í∑∏Î¶¨Í∏∞
                                currentPath = drawRoute(map, path);
                                
                                // Í≤ΩÎ°úÍ∞Ä Î™®Îëê Î≥¥Ïù¥ÎèÑÎ°ù ÏßÄÎèÑ ÏòÅÏó≠ Ï°∞Ï†ï
                                const bounds = new naver.maps.LatLngBounds();
                                path.forEach(coord => bounds.extend(coord));
                                map.fitBounds(bounds);

                                console.log('Route drawn successfully');
                            } else {
                                throw new Error('Invalid route data format');
                            }
                        } catch (error) {
                            console.error('Navigation Error:', error);
                            alert('Í≤ΩÎ°úÎ•º Í∞ÄÏ†∏Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                        }
                    };
                    goBtn.style.display = 'block';

                    // Emergency Info Î≤ÑÌäº ÏÑ§Ï†ï
                    const emergencyInfoBtn = document.getElementById('emergencyInfoBtn');
                    
                    emergencyInfoBtn.onclick = async function() {
                        try {
                            // Get disaster ID from URL
                            let disasterId = null;
                            
                            // URL Í≤ΩÎ°ú Î∂ÑÏÑù
                            const pathSegments = window.location.pathname.split('/');
                            // URL path ÌòïÏãù: /map/disaster_map/earthquake_gangnam
                            if (pathSegments.length >= 4 && pathSegments[2] === 'disaster_map') {
                                disasterId = pathSegments[3];
                            } else {
                                // Í∏∞Ï°¥ ÏøºÎ¶¨ ÌååÎùºÎØ∏ÌÑ∞ Î∞©ÏãùÎèÑ Î∞±ÏóÖÏúºÎ°ú ÏßÄÏõê
                                const urlParams = new URLSearchParams(window.location.search);
                                disasterId = urlParams.get('id');
                            }
                            
                            // Use default if no id found
                            if (!disasterId) {
                                disasterId = 'default';
                            }
                            
                            // Call the API endpoint
                            const response = await fetch(`/api/emergency_info/${disasterId}`);
                            
                            if (!response.ok) {
                                throw new Error(`API error: ${response.status}`);
                            }
                            
                            const data = await response.json();
                            console.log('Emergency Info:', data);
                            
                            // Format the data for display
                            let alertMessage = '===== EMERGENCY INFORMATION =====\n\n';
                            
                            // Add emergency contacts
                            alertMessage += 'üìû EMERGENCY CONTACTS:\n';
                            for (const [contact, number] of Object.entries(data.emergency_contacts)) {
                                alertMessage += `- ${contact.replace('_', ' ').toUpperCase()}: ${number}\n`;
                            }
                            
                            // Add safety instructions
                            alertMessage += '\n‚ö†Ô∏è SAFETY INSTRUCTIONS:\n';
                            data.safety_instructions.forEach((instruction, index) => {
                                alertMessage += `${index + 1}. ${instruction}\n`;
                            });
                            
                            // Add evacuation centers
                            alertMessage += '\nüè® EVACUATION CENTERS:\n';
                            data.evacuation_centers.forEach((center, index) => {
                                alertMessage += `${index + 1}. ${center}\n`;
                            });
                            
                            // Add general advice
                            alertMessage += `\n${data.general_advice}`;
                            
                            // Show alert with the information
                            alert(alertMessage);
                            
                        } catch (error) {
                            console.error('Error fetching emergency info:', error);
                            alert('Emergency information is currently unavailable. Please call 119 for emergencies.');
                        }
                    };
                    emergencyInfoBtn.style.display = 'block';

                    // 12. Í±∞Î¶¨ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                    const distanceToDisaster = calculateDistance(
                        currentLocation.lat,
                        currentLocation.lng,
                        disasterInfo.coordinates.lat,
                        disasterInfo.coordinates.lng
                    ).toFixed(1);
                    
                    document.getElementById('disaster-distance').textContent = `${distanceToDisaster}km`;
                    document.getElementById('disaster-location').textContent = disasterInfo.location;
                    document.getElementById('disaster-type').textContent = disasterInfo.type;

                } catch (error) {
                    console.error('Error:', error);
                    alert('Error loading disaster or shelter information.');
                }
            }, function(error) {
                alert('Cannot get your location. Please check your location permission settings.');
            });
        } else {
            alert('Geolocation is not supported by this browser.');
        }
    </script>
</body>
</html> 